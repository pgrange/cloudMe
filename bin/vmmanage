#!/usr/bin/env bash

#    (c) 2016-2017, n0vember <n0vember@half-9.net>
#
#    This file is part of nocloud.
#
#    nocloud is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    nocloud is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with nocloud.  If not, see <http://www.gnu.org/licenses/>.

usage() {
  echo "$@" >&2
  echo "usage : $(basename $0) -m <VM_NAME> [ -c <CONTEXT> [ -t <TYPE> ] ] [ -i <ISO> ] [ -f <IMG> ]
   or : $(basename $0) -C <VM_NAME> [ -c <CONTEXT> [ -t <TYPE> ] ]
   or : $(basename $0) -T <VM_NAME>
   or : $(basename $0) -s -c <CONTEXT> [ -d ]
  Manages running VMs
  -m : connects to the qemu console of a vm
  -C : connects to the vm console
  -c : restrict selection to this context. Alternative to NC_CONTEXT environment variable. Default = ${vmDefaultContext}.
  -g : alternative to -c, kept for compatibility
  -t : restrict selection to this type
  -T : launch a template
  -s : stop context
  -d : when stopping context, destroy vms
  -f : mount specified floppy image ; if name is 'none', eject floopy
  -i : mount specified iso ; if name is 'none', eject iso
  -h : display this help
  -v : display version and exit" >&2
  exit 1
}

realMe=$(readlink -e $0)
realDir=$(dirname ${realMe})
libDir=../lib
libName=cm_lib
[ -d "${realDir}/${libDir}" ]  || usage "${libDir} directory was not found in ${realDir} : Installation problem."
[ -f "${realDir}/${libDir}/${libName}" ] && . ${realDir}/${libDir}/${libName} || usage "${libName} was not found in ${realDir}/${libDir} : Installation problem."

mode=0
modeName=
vmName=
isoName=
floppyName=
contextName="${vmDefaultContext}"
[ -n "${NC_CONTEXT}" ] && contextName=${NC_CONTEXT}
typeName="*"
stopDestroy=0
while getopts m:C:sg:c:t:T:df:i:hv name
do
  case $name in
    m)
      vmName="$OPTARG"
      modeName="manage"
      mode=$((mode+1))
      ;;
    C)
      vmName="$OPTARG"
      modeName="console"
      mode=$((mode+1))
      ;;
    s)
      modeName="stop"
      mode=$((mode+1))
      ;;
    i)
      isoName="$OPTARG"
      ;;
    f)
      floppyName="$OPTARG"
      ;;
    g|c) contextName="$OPTARG" ;;
    t) typeName="$OPTARG" ;;
    T) vmName="$OPTARG"
       modeName="template"
       mode=$((mode+1))
       ;;
    d) stopDestroy=1 ;;
    h) usage ;;
    v) version ;;
  esac
done
shift $(($OPTIND-1))

[ ${mode} -eq 0 ] && usage "One mode must be specified between -m, -s, -C and -T"
[ ${mode} -gt 1 ] && usage "Only one mode to specify between -m, -s, -C and -T"

if [ -n "${isoName}" ] ; then
  [ ${isoName} == "none" ] && vm_console_command ${vmName} eject ide1-cd0
  [ ${isoName} != "none" ] && vm_console_command ${vmName} change ide1-cd0 "${isoName}"
  modeName=
fi

if [ -n "${floppyName}" ] ; then
  [ ${floppyName} == "none" ] && vm_console_command ${vmName} eject floppy0
  [ ${floppyName} != "none" ] && vm_console_command ${vmName} change floppy0 "${floppyName}"
  modeName=
fi

case ${modeName} in
  "manage")
    [ -z ${vmName} ] && usage "VM name is mandatory"
    vm_running "${contextName}" "${typeName}" | grep "^${vmName}" >/dev/null || usage "no VM runnning with that name"
    vm_console_command ${vmName}
    ;;
  "console")
    [ -z ${vmName} ] && usage "VM name is mandatory"
    vm_running "${contextName}" "${typeName}" | grep "^${vmName}" >/dev/null || usage "no VM runnning with that name"
    port=$(vm_spice_port "${vmName}")
    which spicy >/dev/null 2>&1 || usage "spicy is needed for this feature"
    spicy -h localhost -p $port -w ${vmSpicePassword} --class=qemu-system-${vmSystemType} >/dev/null 2>&1 &
    ;;
  "template")
    [ -z ${vmName} ] && usage "VM name is mandatory"
    vmContext=${vmCreateContext}
    chmod +w $(vm_dir ${vmName} ${vmContext})/$(vm_disks ${vmName} ${vmContext} | head -1)
    is_vm_running ${vmName} ${vmContext} > /dev/null && usage "Machine is already running" || vm_run ${vmName} ${vmContext} ""
    ;;
  "stop")
    [ "${contextName}" == "*" ] && usage "specifying a context name is mandatory to stop a context"
    vm_running "${contextName}" "${typeName}" | while read vmName vmContext vmIp
    do
      vmType=$(echo ${vmContext} | cut -d "/" -f 2)
      vmContext=$(echo ${vmContext} | cut -d "/" -f 1)
      [ "${vmContext}" == "${vmCreateContext}" ] && vmType=""
      vm_stop ${vmName} ${vmContext} ${vmType}
    done
    [ "${contextName}" == "${vmCreateContext}" -a $stopDestroy -eq 1 ] && usage "can't drop ${vmCreateContext}"
    [ $stopDestroy -eq 1 ] && vm_group_destroy ${contextName}
    ;;
esac
