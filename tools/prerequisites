#!/bin/bash

ko() { echo "$1 NOT FOUND."; }
ok() { echo "$1 found."; }
tst() {
  cmd=$1
  name=$2
  eval "${cmd}" >/dev/null 2>&1 && ok ${name} || ko ${name}
}

tst "which qemu-system-$(uname -m)" "qemu"
tst "which dnsmasq" "dnsmasq"
tst "which spicy" "spicy"
tst "which tree" "tree"
tst "which curl" "curl"

for oldFile in bin/vmrunning bin/vmcreate bin/vminstantiate bin/vmstop bin/vmconsole bin/vm
do
  [ -f /usr/local/${oldFile} ] && rm /usr/local/${oldFile} || echo -n
done

# Grant kvm group the right to set port translations
echo "%kvm ALL=(ALL) NOPASSWD: /usr/local/sbin/vmnat" > /etc/sudoers.d/kvm-iptables

# Check user
user_name=$(stat -c %U $(tty))
other_user_name=""
if [ "${user_name}" == root ] ; then
  echo installing as root...
  echo -n "do you want to set up an other user to use nocloud ? (yes/no)"
  read other_user
  case "${other_user}" in
    "y|yes")
      while $(grep "^${other_user_name}:" /etc/passwd)
      do
        echo -n "give te user's name : "
        read other_user_name
      done
      user_name=${other_user_name}
      ;;
    "*")
      echo "I don't think using root is a good idea, but OK"
      ;;
  esac
fi
echo "adding user ${user_name} in kvm group"
usermod -a -G kvm ${user_name}

# initiate dhcp-hostsfile
touch /usr/local/etc/nocloud-dhcp-hostsfile
chmod 664 /usr/local/etc/nocloud-dhcp-hostsfile
chown root:kvm /usr/local/etc/nocloud-dhcp-hostsfile

# try to guess your network dns service
. etc/nocloud_net.conf
systemctl status systemd-resolved >/dev/null 2>&1
if [ $? -eq 0 ] ; then
  systemdResolved=1
  grep "^DNS=.*${bridgeIpAddress}" /etc/systemd/resolved.conf > /dev/null 2>&1 \
    || sed -i -r 's/^#*(DNS)=(.*)/\1=${bridgeIpAddress} \2/' /etc/systemd/resolved.conf
  grep "^Domains=.*nocloud" /etc/systemd/resolved.conf > /dev/null 2>&1 \
    || sed -i -r 's/^#*(Domains)=(.*)/\1=nocloud \2/' /etc/systemd/resolved.conf
  systemctl restart systemd-resolved >/dev/null 2>&1
else
  systemctl status resolvconf.service >/dev/null 2>&1
  if [ $? -eq 0 ] ; then
    resolvconf=1
    [ -f /etc/resolvconf.conf ] && resolvconfFile=/etc/resolvconf.conf
    [ -f /etc/resolvconf/resolv.conf.d/head ] && resolvconfFile=/etc/resolvconf/resolv.conf.d/head
    if [ -z "${resolvconfFile}" ] ; then
      echo "=== I wasn't able to guess your resolving system"
      echo "=== please add your nocloud ip address as dns server (default 192.168.1.1)"
    fi
    grep "nameserver ${bridgeIpAddress}" ${resolvconfFile} > /dev/null 2>&1 \
      || echo "nameserver ${bridgeIpAddress}" >> ${resolvconfFile}
    resolvconf -u
  else
    echo "=== I wasn't able to guess your resolving system"
    echo "=== please add your nocloud ip address as dns server (default 192.168.1.1)"
  fi
fi
